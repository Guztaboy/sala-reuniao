<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <title>Agenda da Sala</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#1a1f2e;
      --surface:#242938;
      --surface2:#2d3347;
      --border:#353d55;
      --text:#e8edf5;
      --muted:#7b8aaa;
      --free:#42a5f5;
      --free-bg:rgba(66,165,245,.13);
      --busy:#ef5350;
      --busy-bg:rgba(239,83,80,.13);
      --accent:#64b5f6;
      --now:#1e88e5;
      --now-bg:rgba(30,136,229,.12);
      --card-shadow:0 2px 16px rgba(0,0,0,.25);
    }
    html,body{height:100%;width:100%;background:var(--bg);color:var(--text);
      font-family:'Segoe UI',system-ui,sans-serif;overflow:hidden}

    /* LAYOUT â€” 4 colunas: conteÃºdo | divider | prÃ³ximas | qrcode */
    .screen{display:grid;grid-template-rows:auto 1fr;height:100vh;padding:2.8vw 3.5vw;gap:2.5vh}
    header{display:flex;justify-content:space-between;align-items:flex-start;
      border-bottom:1px solid var(--border);padding-bottom:2.2vh}
    .room-info{display:flex;flex-direction:column;gap:.6vh}
    .room-label{font-size:1.05vw;font-weight:600;text-transform:uppercase;
      letter-spacing:.2em;color:var(--muted)}
    .room-name{font-size:4vw;font-weight:800;line-height:1;color:var(--text)}
    .status-badge{display:inline-flex;align-items:center;gap:.8vw;padding:.6vh 1.6vw;
      border-radius:999px;font-size:1.5vw;font-weight:700;letter-spacing:.06em;
      text-transform:uppercase;border:2px solid transparent;transition:all .5s;margin-top:.5vh}
    .status-badge.free{background:var(--free-bg);border-color:var(--free);color:var(--free)}
    .status-badge.busy{background:var(--busy-bg);border-color:var(--busy);color:var(--busy)}
    .status-dot{width:.85vw;height:.85vw;border-radius:50%;animation:pulse 1.8s infinite}
    .free .status-dot{background:var(--free)}.busy .status-dot{background:var(--busy)}
    @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.3;transform:scale(.7)}}
    .logo-placeholder{width:7vw;height:4.5vh;border:1.5px dashed var(--border);
      border-radius:.8vw;display:flex;align-items:center;justify-content:center;
      font-size:.8vw;color:var(--muted);letter-spacing:.08em;opacity:.5}
    .clock-block{text-align:right}
    .clock{font-size:4.8vw;font-weight:200;font-variant-numeric:tabular-nums;
      line-height:1;color:var(--accent)}
    .date-str{font-size:1.1vw;color:var(--muted);margin-top:.5vh;text-transform:capitalize}

    /* CORPO */
    .body{display:grid;grid-template-columns:1fr 1px 1.5fr 1px auto;gap:0 2.5vw;min-height:0}
    .divider{background:var(--border);align-self:stretch}
    .now-section,.next-section{display:flex;flex-direction:column;gap:1.4vh}
    .section-label{font-size:.95vw;font-weight:700;text-transform:uppercase;
      letter-spacing:.18em;color:var(--muted)}

    /* CARD EM ANDAMENTO */
    .now-card{flex:1;border:1px solid var(--border);border-radius:1.2vw;
      background:var(--surface);box-shadow:var(--card-shadow);
      padding:2.2vh 2vw;display:flex;flex-direction:column;justify-content:center;gap:2vh}
    .now-card.occupied{border-color:var(--now);background:var(--now-bg)}
    .now-card.empty{align-items:center;justify-content:center}
    .now-title{font-size:2.4vw;font-weight:700;line-height:1.2;color:var(--text)}
    .now-time-row{display:flex;align-items:center;gap:1vw}
    .now-time{font-size:1.6vw;font-weight:600;color:var(--accent);white-space:nowrap}
    .progress-bar-wrap{height:.5vh;background:var(--border);border-radius:999px;overflow:hidden;flex:1}
    .progress-bar{height:100%;background:var(--accent);border-radius:999px;transition:width 30s linear}
    .now-organizer{font-size:1.05vw;color:var(--muted)}
    .empty-msg{font-size:1.5vw;color:var(--muted);text-align:center;line-height:1.7}
    .free-icon{font-size:2.8vw;margin-bottom:.8vh;opacity:.35}

    /* LISTA PRÃ“XIMAS */
    .meetings-list{display:flex;flex-direction:column;gap:1vh;overflow:hidden;flex:1}
    .meeting-card{display:grid;grid-template-columns:auto 2px 1fr auto;
      align-items:center;gap:1.2vw;background:var(--surface);
      border:1px solid var(--border);border-radius:.9vw;
      padding:1.4vh 1.6vw;box-shadow:var(--card-shadow)}
    .meeting-time-col{text-align:right}
    .meeting-start{font-size:1.8vw;font-weight:700;font-variant-numeric:tabular-nums;color:var(--accent)}
    .meeting-end{font-size:1vw;color:var(--muted)}
    .meeting-vline{background:var(--border);align-self:stretch;min-height:3.5vh}
    .meeting-info{overflow:hidden}
    .meeting-title{font-size:1.6vw;font-weight:600;color:var(--text);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meeting-organizer{font-size:.95vw;color:var(--muted);margin-top:.2vh;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meeting-duration{font-size:.95vw;white-space:nowrap;
      background:var(--free-bg);color:var(--free);
      padding:.25vh .7vw;border-radius:999px;font-weight:600}
    .no-meetings{flex:1;display:flex;flex-direction:column;align-items:center;
      justify-content:center;gap:1vh;font-size:1.4vw;color:var(--muted)}

    /* QR CODE */
    .qr-section{display:flex;flex-direction:column;gap:1.2vh;align-items:center;width:12vw}
    .qr-box{background:var(--surface);border:1px solid var(--border);
      border-radius:1.2vw;padding:1.5vh 1.2vw;
      display:flex;flex-direction:column;align-items:center;gap:1.2vh;
      box-shadow:var(--card-shadow);flex:1;justify-content:center}
    .qr-canvas{background:#fff;border-radius:.6vw;padding:.5vw;
      width:9vw;height:9vw;display:flex;align-items:center;justify-content:center}
    .qr-canvas img,.qr-canvas canvas{width:100%!important;height:100%!important}
    .qr-label{font-size:.85vw;font-weight:600;text-transform:uppercase;
      letter-spacing:.14em;color:var(--muted);text-align:center}
    .qr-sublabel{font-size:.8vw;color:var(--muted);text-align:center;
      opacity:.7;line-height:1.4}
    .qr-placeholder{width:100%;height:100%;background:var(--surface2);
      border-radius:.4vw;display:flex;align-items:center;justify-content:center;
      font-size:.75vw;color:var(--muted);text-align:center;padding:.5vw;line-height:1.5}

    /* LOADING / ERROR */
    .loading-overlay{position:fixed;inset:0;background:var(--bg);display:flex;
      flex-direction:column;align-items:center;justify-content:center;gap:2vh;
      z-index:100;transition:opacity .6s}
    .loading-overlay.hidden{opacity:0;pointer-events:none}
    .spinner{width:3.5vw;height:3.5vw;border:.35vw solid var(--border);
      border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-text{font-size:1.2vw;color:var(--muted)}
    .error-box{position:fixed;bottom:2vh;left:50%;transform:translateX(-50%);
      background:var(--busy-bg);border:1px solid var(--busy);color:var(--busy);
      padding:1vh 2vw;border-radius:.8vw;font-size:1vw;display:none}
    .watermark{position:fixed;bottom:1.2vh;right:1.8vw;font-size:.75vw;
      color:var(--border);letter-spacing:.12em}
    .top-bar{position:fixed;top:0;left:0;right:0;height:.45vh;
      background:linear-gradient(90deg,var(--free),var(--now))}
  </style>
</head>
<body>

<div class="top-bar"></div>
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">Carregando agenda...</div>
</div>
<div class="error-box" id="errorBox"></div>

<div class="screen">
  <header>
    <div class="room-info">
      <span class="room-label">Sala de Reuniao</span>
      <span class="room-name" id="roomName">Carregando...</span>
      <span class="status-badge free" id="statusBadge">
        <span class="status-dot"></span>
        <span id="statusText">Livre</span>
      </span>
    </div>
    <div class="clock-block">
      <div class="clock" id="clock">00:00</div>
      <div class="date-str" id="dateStr">...</div>
    </div>
  </header>

  <div class="body">
    <!-- Em andamento -->
    <div class="now-section">
      <span class="section-label">Em andamento</span>
      <div class="now-card empty" id="nowCard">
        <div class="free-icon" id="freeIcon">ðŸ“‹</div>
        <span class="empty-msg" id="nowEmpty">Nenhuma reuniao<br>em andamento</span>
        <div id="nowContent" style="display:none;flex-direction:column;gap:2vh">
          <div class="now-title" id="nowTitle"></div>
          <div class="now-time-row">
            <span class="now-time" id="nowTime"></span>
            <div class="progress-bar-wrap">
              <div class="progress-bar" id="nowProgress" style="width:0%"></div>
            </div>
          </div>
          <div class="now-organizer" id="nowOrganizer"></div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Proximas -->
    <div class="next-section">
      <span class="section-label">Proximas reuniÃµes</span>
      <div class="meetings-list" id="meetingsList">
        <div class="no-meetings"><span>ðŸ“…</span>Nenhuma reuniao agendada</div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- QR Code -->
    <div class="qr-section">
      <span class="section-label">Agendar</span>
      <div class="logo-block" id="logoBlock" style="width:100%;display:flex;align-items:center;justify-content:center;background:var(--surface);border:1px solid var(--border);border-radius:1vw;padding:1.2vh .8vw;box-shadow:var(--card-shadow)">
        <div class="logo-placeholder" id="logoPlaceholder">LOGO</div>
        <img id="logoImg" src="" alt="Logo" style="display:none;max-height:4.5vh;max-width:10vw;object-fit:contain;opacity:.92"/>
      </div>
      <div class="qr-box">
        <div class="qr-canvas" id="qrCanvas">
          <div class="qr-placeholder" id="qrPlaceholder">Configure o link no CONFIG.qrUrl</div>
        </div>
        <div class="qr-label">Agende sua reuniao</div>
        <div class="qr-sublabel">Escaneie o<br>QR Code</div>
      </div>
    </div>
  </div>
</div>

<div class="watermark">AO VIVO</div>

<script>
var CONFIG = {
  firebase: {
    apiKey: "AIzaSyA8crGl2xSoe8c0kRDA03CxRcsJtsH-Hz8",
    authDomain: "painel-engenharia-e2b60.firebaseapp.com",
    projectId: "painel-engenharia-e2b60",
    storageBucket: "painel-engenharia-e2b60.firebasestorage.app",
    messagingSenderId: "754848525033",
    appId: "1:754848525033:web:10dc9a0eba7395fc069e78"
  },
  colecao:    "sala1",
  nomeDaSala: "Sala Pacaembu",

  // URL que abre ao escanear o QR Code
  // Ex: link do Outlook, Teams, Google Calendar, etc.
  // Deixe "" para nao exibir o QR
  qrUrl: "https://outlook.office.com/calendar",

  // URL da imagem do logo da empresa
  // Ex: "https://suaempresa.com/logo.png"
  logoUrl: "https://globalsrv.com.br/wp-content/uploads/2023/02/Logo_60px_white.png"
};

firebase.initializeApp(CONFIG.firebase);

/* Logo */
if(CONFIG.logoUrl) {
  var img = document.getElementById('logoImg');
  var placeholder = document.getElementById('logoPlaceholder');
  img.src = CONFIG.logoUrl;
  img.style.display = 'block';
  placeholder.style.display = 'none';
  img.onerror = function(){ img.style.display='none'; placeholder.style.display='flex'; };
}
var db = firebase.firestore();
document.getElementById('roomName').textContent = CONFIG.nomeDaSala;

/* QR Code */
if(CONFIG.qrUrl) {
  document.getElementById('qrPlaceholder').style.display = 'none';
  new QRCode(document.getElementById('qrCanvas'), {
    text: CONFIG.qrUrl,
    width: 200,
    height: 200,
    colorDark: '#1a1f2e',
    colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.M
  });
}

/* Relogio */
var pad = function(n){ return String(n).padStart(2,'0'); };
function updateClock(){
  var now = new Date();
  document.getElementById('clock').textContent = pad(now.getHours())+':'+pad(now.getMinutes());
  document.getElementById('dateStr').textContent = now.toLocaleDateString('pt-BR',{
    weekday:'long', day:'2-digit', month:'long', year:'numeric'
  });
}
updateClock(); setInterval(updateClock, 10000);

/* Helpers */
function startOfDay(d){ return new Date(d.getFullYear(),d.getMonth(),d.getDate()); }
function endOfDay(d){ return new Date(d.getFullYear(),d.getMonth(),d.getDate(),23,59,59); }
function fmtTime(d){ return pad(d.getHours())+':'+pad(d.getMinutes()); }
function duration(s,e){
  var m = Math.round((e-s)/60000);
  if(m<=0) return '';
  return m>=60 ? Math.floor(m/60)+'h'+(m%60 ? pad(m%60)+'min':'') : m+'min';
}
function setStatus(s){
  document.getElementById('statusBadge').className = 'status-badge '+s;
  document.getElementById('statusText').textContent = s==='free' ? 'Livre' : 'Ocupada';
}
function hideLoading(){ document.getElementById('loadingOverlay').classList.add('hidden'); }
function showError(msg){
  var el = document.getElementById('errorBox');
  el.textContent = 'Erro: '+msg; el.style.display='block';
  console.error(msg); hideLoading();
}
function fmtOrganizer(str){
  if(!str) return '';
  var local = str.split('@')[0];
  return local.replace(/[._]/g,' ').replace(/\b\w/g,function(c){ return c.toUpperCase(); });
}

/* Renderizar */
function renderMeetings(docs){
  var now = new Date();
  var meetings = [];
  docs.forEach(function(d){
    var data = d.data();
    var s = new Date(data.inicio || data.start || '');
    var e = new Date(data.fim   || data.end   || '');
    if(isNaN(s)||isNaN(e)) return;
    if(s < startOfDay(now) || s > endOfDay(now)) return;
    meetings.push({ titulo:data.titulo||data.title||'(sem titulo)', organizer:data.organizer||'', _s:s, _e:e });
  });
  meetings.sort(function(a,b){ return a._s-b._s; });

  var cur = null;
  for(var i=0;i<meetings.length;i++){
    if(meetings[i]._s<=now && meetings[i]._e>=now){ cur=meetings[i]; break; }
  }

  var nowCard = document.getElementById('nowCard');
  if(cur){
    nowCard.className = 'now-card occupied';
    document.getElementById('nowEmpty').style.display='none';
    document.getElementById('freeIcon').style.display='none';
    var nc=document.getElementById('nowContent'); nc.style.display='flex';
    document.getElementById('nowTitle').textContent=cur.titulo;
    document.getElementById('nowTime').textContent=fmtTime(cur._s)+' -> '+fmtTime(cur._e);
    var org=fmtOrganizer(cur.organizer);
    document.getElementById('nowOrganizer').textContent=org?'ðŸ‘¤ '+org:'';
    var pct=Math.min(100,((now-cur._s)/(cur._e-cur._s))*100);
    document.getElementById('nowProgress').style.width=pct+'%';
    setStatus('busy');
  } else {
    nowCard.className='now-card empty';
    document.getElementById('nowEmpty').style.display='';
    document.getElementById('freeIcon').style.display='';
    document.getElementById('nowContent').style.display='none';
    setStatus('free');
  }

  var upcoming=meetings.filter(function(m){ return m._s>now; }).slice(0,6);
  var list=document.getElementById('meetingsList');
  if(!upcoming.length){
    list.innerHTML='<div class="no-meetings"><span>ðŸ“…</span>Nenhuma reuniao agendada para hoje</div>';
  } else {
    list.innerHTML=upcoming.map(function(m){
      var org=fmtOrganizer(m.organizer);
      return '<div class="meeting-card">'
        +'<div class="meeting-time-col"><div class="meeting-start">'+fmtTime(m._s)+'</div><div class="meeting-end">'+fmtTime(m._e)+'</div></div>'
        +'<div class="meeting-vline"></div>'
        +'<div class="meeting-info"><div class="meeting-title">'+m.titulo+'</div>'+(org?'<div class="meeting-organizer">ðŸ‘¤ '+org+'</div>':'')+'</div>'
        +'<div class="meeting-duration">'+duration(m._s,m._e)+'</div>'
        +'</div>';
    }).join('');
  }
  hideLoading();
}

db.collection(CONFIG.colecao)
  .onSnapshot(function(snap){ renderMeetings(snap.docs); },
              function(err){ showError(err.message); });

setInterval(function(){
  db.collection(CONFIG.colecao).get().then(function(snap){ renderMeetings(snap.docs); });
}, 60000);
</script>
</body>
</html>
